안녕하세요! 홍성민입니다
이번에 테라폼 책 배송이 늦어져 3장 중반까지 실습을 진행해보았습니다.
다음주 분량까지는 꼭 공부해 오도록 하겠습니다.
책이 오기 전까지 테라폼 블로그들을 읽어보며 흐름을 이해하고 이를 정리할 수 밖에 없었습니다.
발표는 이 글들에 대해 간략히 설명해 보도록 하겠습니다.

저는 아직 이와 같은 인프라를 관리하는 것 뿐만 아니라 CI/CD 등 배포하고 관리해본적은 한번도 없어 이에대한 배경 지식이 부족하다고 생각합니다.
다 아실수도 있는 내용이지만 한번씩 다시 정리하신다고 생각하고 맘편히 들어주시면 감사하겠습니다.

테라폼은 인프라를 코드형태로 관리하게 해주는 도구로 '선언전 언어 방식'을 따릅니다.
기존의 구성사항을 고려하지 않고 최종상태를 어떻게 구현할 것인지에 초점을 두는 멱등성이란 특징을 가지고 있습니다.

여러 블로그를 공부하던 중 카카오 뱅크 팀에서 테라폼을 사용한 것을 알 수 있는데요, 이에 대해 제가 정리해보았고
테라폼을 어떤 식으로 사용할 수 있는지에 대해 알 수 있었습니다.

카카오뱅크에선 온 프레미스 환경에서 서버의 생성, 자동화 프로세스, 모니터링 등을 자동으로 관리할 수 있는 방법에 대해 고민하게 되었고 이에 대한 아이디어로 테라폼을 사용해 자동화 솔루션을 구축했습니다.
온 프레미스 환경이란 원격 환경에서 서버를 운영하는 클라우드와는 대비되는 개념으로 기업이 서버를 자체적으로 보유하고 직접 설치 및 운용하는 방식을 말합니다.

카카오뱅크에서 테라폼을 운용하면서 문제가 생겼는데요,
테라폼을 통해 생성한 VM 서버 리소스에는

1. 자동화 툴에서 서버를 인식해야 하고
2. 모니터링 툴에 서버를 추가해야 하는 추가 설정 작업이 필요했습니다.

따라서

1. 테라폼 Provider로 리소스 생성을 자동화
2. 자동화 솔루션과 생성된 리소스를 자동 연동
3. 모니터링 솔루션으로 생성된 리소스 인식이 필요했습니다.

카카오 뱅크 팀에서 간단히 정리한 테라폼에 대해 간략히 알아보면서 이에 대해 말씀드리겠습니다.

테라폼 워크플로우는 Write, Plan, Apply 총 3 단계로 구분됩니다.

먼저 Write는
테라폼을 작성하는 단계로
위 사진은 AWS Provider에 SQS Queue 리소스를 생성하는 테라폼 코드의 일부입니다.

Provider 정의 Block에선 어떤 Provider를 사용해 프로비저닝(서버, AWS EC2 인스턴스 같은 가상 서버를 자동으로 생성하고 설정하는 것) 할 지를 결정합니다
이어서 Resource 정의 Block에선 aws_sqs_queue 리소스를 terraform_queue라는 이름으로 생성하라’ 라는 내용이 블록에 정의되어 있는 것을 알 수 있습니다.

그 다음 Plan은 지정된 상태와 코드를 비교하는 단계로
CI(Continuous Integration) 관점에서 보면, 코드에 대한 **변경 커밋**을 생성해 **PR(Pull Request)**를 날린 상태라고 할 수 있다. 해당 코드 실행 결과, 어떤 변경 사항이 있을 지를 보여준다

이처럼 Plan 단계는 테라폼 백엔드(State 상태 파일)에 저장된 상태를 비교하면서 Write단계에서 작성한 **인프라 코드를 검증하는 단계이다.**

마지막 Apply 단계에선 앞서 Plan 단계에서 검증된 결과를 바탕으로 실제 인프라에 적용해보는 단계라 할 수 있습니다.

백엔드는 모두들 공부하면서 한번씩 보신 State 파일로 현재 인프라의 상태 정보를 말합니다.
여기서 카카오뱅크팀은 이 State 파일을 통해 변경되는 인프라의 상태를 알 수 있다면,
인프라 리소스가 생성/삭제/수정되는 추적할 수 있고 변경이 발생할 때마다 자동화된 대응이 가능해진다는 것을 알아냈습니다.
(2번을 해결)

여기서 백엔드의 상태정보를 가시적으로 확인할 수 있는 Terraboard 오픈소스를 이용했습니다.
위에서 언급한 테라폼 프로바이더란 Apply 단계에서 API 호출로 실제 리소스를 생성하는 역할입니다

이제 테라폼을 통해 해당 과정에 대해 말씀드리겠습니다.
먼저 테라폼으로 리소스를 생성합니다.
보시면 알 수 있듯이 hci 프로바이더의 instance리소스 유형인 것을 알 수 있고 고유 이름은 my_instance인 것을 알 수 있습니다.
그렇지만 생성한 리소스엔 기본적인 정보 외에는 아무것도 없는데요,
카카오뱅크 팀은 여기에 자동화 솔루션과 모니터링 솔루션을 자동화할 기술이 필요했습니다.

그래서 카카오 팀은 Custom 테라폼 Provider를 만들어 추가적인 정보를 자동으로 매핑 할 수 있도록 하였습니다.
아래 글들은 이 과정으로 어떻게 자동화 솔루션과 연동을 하는지에 대한 설명입니다.

그 후 마지막으로 프로메테우스(모니터링 서비스)와 연동이 필요했는데 이 또한 리소스를 생성할 때 보면 메트릭 라벨을 넣어주어 수집이 가능하게 한 것을 알 수 있습니다.

부족하지만 긴 설명 들어주셔서 감사합니다.